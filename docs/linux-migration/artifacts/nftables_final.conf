#!/usr/sbin/nft -f

###############################################################################
#  nftables Firewall - Debian 13 Workstation
#  Clean, audited rule set reflecting best practices and portfolio documentation
###############################################################################

flush ruleset

table inet filter {

  ##
  ## INPUT CHAIN
  ##
  chain input {
    type filter hook input priority filter; policy drop;

    # Allow loopback â€” always first
    iif "lo" accept

    # Allow established or related connections
    ct state established,related accept

    # Allow ICMP (IPv4 + IPv6)
    ip protocol icmp accept
    ip6 nexthdr ipv6-icmp accept

    # Allow DHCP client traffic
    udp sport 67 udp dport 68 accept
    udp sport 68 udp dport 67 accept

    # Allow virtualization bridge (VMs)
    iif "virbr0" accept

    # SSH: allow ONLY from localhost
    # (Loopback bypasses filtering, but we make intent explicit)
    iif "lo" tcp dport 22 accept

    # Drop SSH on wireless LAN interface explicitly
    iif "wlp0s20f3" tcp dport 22 drop

    # Generic SSH drop for all other interfaces
    tcp dport 22 drop

    # Log remaining drops (optional but useful)
    log prefix "nftables DROP INPUT: " flags all counter drop
  }

  ##
  ## FORWARD CHAIN
  ##
  chain forward {
    type filter hook forward priority filter; policy drop;

    # Allow VM -> host internet (masqueraded by NAT in ip nat)
    iifname "virbr0" oifname "wlp0s20f3" accept

    # Allow host <- VM return traffic
    iifname "wlp0s20f3" oifname "virbr0" ct state established,related accept
  }

  ##
  ## OUTPUT CHAIN
  ##
  chain output {
    type filter hook output priority filter; policy accept;
  }
}

###############################################################################
# NAT TABLE (IPv4)
###############################################################################
table ip nat {

  chain prerouting {
    type nat hook prerouting priority -100; policy accept;
  }

  chain postrouting {
    type nat hook postrouting priority 100; policy accept;

    # Masquerade VM traffic out the wireless LAN interface
    oifname "wlp0s20f3" ip saddr ip-redacted/24 masquerade
  }
}

